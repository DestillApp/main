<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: graphql/resolvers/distillatonArchivesResolvers.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: graphql/resolvers/distillatonArchivesResolvers.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @module graphql/resolvers/distillationArchivesResolvers
 * @description Distillation Archives resolvers for GraphQL queries and mutations.
 * Handles creating and fetching distillation archives.
 */

// Importing the DistillationArchives model
const DistillationArchives = require("../../database/distillationArchives");

const { filterData } = require("../../util/dataformating");
const {
  formatDate,
  formatDateToString,
  parseDDMMYYYYtoDate,
} = require("../../util/dateformater");

// Importing required modules
const { GraphQLError } = require("graphql");
const { requireAuth } = require("../../util/authChecking");
const {
  sanitizeDistillationArchiveInput,
} = require("../../util/sanitization/distillationArchiveSanitizer");

const distillationArchivesResolvers = {
  Query: {
    /**
     * @async
     * @function getDistillationArchives
     * @description Fetches all distillation archives from the database with optional filtering and sorting.
     * @param {Object} _ - Unused parent parameter.
     * @param {Object} args - Query arguments.
     * @param {string[]} args.fields - Array of fields to include in the response.
     * @param {string} [args.name] - Optional plant name filter for case-insensitive search.
     * @param {string} [args.sorting] - Optional sorting parameter (plantName, createdAt, youngDate, oldDate).
     * @param {boolean} args.formatDates - Whether to format date fields for display.
     * @param {Object} context - GraphQL context object.
     * @param {Object} context.user - The authenticated user.
     * @returns {Promise&lt;Array>} Array of distillation archive objects with optional formatted dates.
     * @throws {GraphQLError} When authentication fails or database operation fails.
     */
    getDistillationArchives: async (
      _,
      { fields, name, sorting, formatDates },
      { user }
    ) => {
      requireAuth(user);

      try {
        // Build a projection object based on the fields argument
        const projection = {};
        fields.forEach((field) => {
          projection[field] = 1;
        });

        const filter = { userId: user.id };

        // If a name is provided, add it to the filter
        if (name) {
          filter["distilledPlant.plantName"] = {
            $regex: new RegExp(name, "i"),
          }; // Case-insensitive search
        }

        // Build a sort object based on sortingProps
        let sort = null;
        if (sorting === "plantName") {
          sort = { "distilledPlant.plantName": 1 };
        } else if (sorting === "createdAt") {
          sort = { createdAt: 1 };
        } else if (sorting === "youngDate") {
          sort = { date: -1 };
        } else if (sorting === "oldDate") {
          sort = { date: 1 };
        }

        // Fetch distillation archives with the specified fields and filters from the database
        const distillationArchives = sort
          ? await DistillationArchives.find(filter, projection).sort(sort)
          : await DistillationArchives.find(filter, projection);

        // Return the formatted result
        return distillationArchives.map((archive) => {
          const formattedArchive = { ...archive._doc }; // For Mongoose

          // Format specific date fields if needed
          if (formatDates) {
            if (formattedArchive.distillationData.distillationDate) {
              formattedArchive.distillationData.distillationDate = formatDate(
                formattedArchive.distillationData.distillationDate
              );
            }
            if (formattedArchive.distilledPlant.plantBuyDate) {
              formattedArchive.distilledPlant.plantBuyDate = formatDate(
                formattedArchive.distilledPlant.plantBuyDate
              );
            }
            if (formattedArchive.distilledPlant.harvestDate) {
              formattedArchive.distilledPlant.harvestDate = formatDate(
                formattedArchive.distilledPlant.harvestDate
              );
            }
          }

          return formattedArchive;
        });
      } catch (error) {
        if (error instanceof GraphQLError) {
          throw error;
        }
        throw new Error(
          "Failed to fetch distillation archives: " + error.message
        );
      }
    },

    /**
     * @async
     * @function getArchiveDistillationById
     * @description Fetches a specific distillation archive by its ID with optional date formatting.
     * @param {Object} _ - Unused parent parameter.
     * @param {Object} args - Query arguments.
     * @param {string} args.id - The ID of the distillation archive to fetch.
     * @param {boolean} args.formatDistillDate - Whether to format distillation date fields for display.
     * @param {Object} context - GraphQL context object.
     * @param {Object} context.user - The authenticated user.
     * @returns {Promise&lt;Object>} The distillation archive object with optional formatted dates.
     * @throws {GraphQLError} When authentication fails or archive is not found.
     */
    getArchiveDistillationById: async (
      _,
      { id, formatDistillDate },
      { user }
    ) => {
      requireAuth(user);
      try {
        const archive = await DistillationArchives.findOne({
          _id: id,
          userId: user.id,
        });
        if (!archive) {
          throw new Error("Distillation archive not found");
        }

        if (archive.distilledPlant.plantBuyDate) {
          archive.distilledPlant.plantBuyDate = formatDate(
            archive.distilledPlant.plantBuyDate
          );
        }
        if (archive.distilledPlant.harvestDate) {
          archive.distilledPlant.harvestDate = formatDate(
            archive.distilledPlant.harvestDate
          );
        }

        // Format specific date fields if needed
        if (formatDistillDate) {
          if (archive.distillationData.distillationDate) {
            archive.distillationData.distillationDate = formatDate(
              archive.distillationData.distillationDate
            );
          }
        }

        return archive;
      } catch (error) {
        if (error instanceof GraphQLError) {
          throw error;
        }
        throw new Error(
          "Failed to fetch distillation archive by ID: " + error.message
        );
      }
    },
  },

  Mutation: {
    /**
     * @async
     * @function createDistillationArchive
     * @description Creates a new distillation archive and saves it to the database.
     * @param {Object} _ - Unused parent parameter.
     * @param {Object} args - Mutation arguments.
     * @param {Object} args.distillationArchiveInput - Input data for the new distillation archive.
     * @param {Object} context - GraphQL context object.
     * @param {Object} context.user - The authenticated user creating the distillation archive.
     * @returns {Promise&lt;Object>} The created distillation archive object.
     * @throws {GraphQLError} When authentication fails or creation fails.
     */
    createDistillationArchive: async (
      _,
      { distillationArchiveInput },
      { user }
    ) => {
      requireAuth(user);

      // Sanitize all input fields
      const sanitizedInput = sanitizeDistillationArchiveInput(
        distillationArchiveInput
      );

      // Parse date for backend (from distillationData.distillationDate)
      const sanitizedDate = sanitizedInput.distillationData?.distillationDate;
      const validDate = sanitizedDate
        ? parseDDMMYYYYtoDate(sanitizedDate)
        : new Date();

      const sanitizedData = {
        ...sanitizedInput,
        date: validDate,
        userId: user.id,
        createdAt: Date.now(),
      };

      // Filtering out null or empty string values
      const filteredData = filterData(sanitizedData);

      try {
        // Creating a new DistillationArchives instance
        const distillationArchive = new DistillationArchives(filteredData);
        // Saving the distillation archive to the database
        const result = await distillationArchive.save();
        return result;
      } catch (error) {
        if (error instanceof GraphQLError) {
          throw error;
        }
        console.error("Error details:", err);
        throw new Error("Failed to create distillation archive");
      }
    },

    /**
     * @async
     * @function updateDistillationArchive
     * @description Updates an existing distillation archive and saves it to the database.
     * @param {Object} _ - Unused parent parameter.
     * @param {Object} args - Mutation arguments.
     * @param {string} args.id - ID of the distillation archive to update.
     * @param {Object} args.distillationArchiveInput - Input data for the distillation archive update.
     * @param {Object} context - GraphQL context object.
     * @param {Object} context.user - The authenticated user updating the distillation archive.
     * @returns {Promise&lt;Object>} The updated distillation archive object.
     * @throws {GraphQLError} When authentication fails or update fails.
     */
    updateDistillationArchive: async (
      _,
      { id, distillationArchiveInput },
      { user }
    ) => {
      requireAuth(user);

      // Sanitize all input fields
      const sanitizedInput = sanitizeDistillationArchiveInput(
        distillationArchiveInput
      );

      // Parse date for backend (from distillationData.distillationDate)
      const sanitizedDate = sanitizedInput.distillationData?.distillationDate;
      const validDate = sanitizedDate
        ? parseDDMMYYYYtoDate(sanitizedDate)
        : new Date();

      const sanitizedData = {
        ...sanitizedInput,
        date: validDate,
        userId: user.id,
      };

      // Filtering out null or empty string values
      const filteredData = filterData(sanitizedData);

      try {
        const { createdAt, ...updateData } = filteredData;

        const updatedDistillationArchive =
          await DistillationArchives.findByIdAndUpdate(id, updateData, {
            new: true,
          });
        return updatedDistillationArchive;
      } catch (error) {
        if (error instanceof GraphQLError) {
          throw error;
        }
        throw new Error("Failed to update distillation archive");
      }
    },

    /**
     * @async
     * @function deleteDistillationArchive
     * @description Deletes a distillation archive from the database.
     * @param {Object} _ - Unused parent parameter.
     * @param {Object} args - Mutation arguments.
     * @param {string} args.id - ID of the distillation archive to delete.
     * @param {Object} context - GraphQL context object.
     * @param {Object} context.user - The authenticated user deleting the distillation archive.
     * @returns {Promise&lt;boolean>} True if deletion was successful, false otherwise.
     * @throws {GraphQLError} When authentication fails.
     */
    deleteDistillationArchive: async (_, { id }, { user }) => {
      requireAuth(user);

      try {
        await DistillationArchives.findOneAndDelete({
          _id: id,
          userId: user.id,
        });
        return true;
      } catch (error) {
        if (error instanceof GraphQLError) {
          throw error;
        }
        console.error("Failed to delete distillation archive:", error);
        return false;
      }
    },
  },
};

// Exporting the distillation archives resolvers
module.exports = distillationArchivesResolvers;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-app.html">app</a></li><li><a href="module-database_distillation.html">database/distillation</a></li><li><a href="module-database_distillationArchives.html">database/distillationArchives</a></li><li><a href="module-database_plant.html">database/plant</a></li><li><a href="module-database_settings.html">database/settings</a></li><li><a href="module-database_user.html">database/user</a></li><li><a href="module-graphql_index.html">graphql/index</a></li><li><a href="module-graphql_resolvers_countryResolvers.html">graphql/resolvers/countryResolvers</a></li><li><a href="module-graphql_resolvers_distillationArchivesResolvers.html">graphql/resolvers/distillationArchivesResolvers</a></li><li><a href="module-graphql_resolvers_distillationResolvers.html">graphql/resolvers/distillationResolvers</a></li><li><a href="module-graphql_resolvers_index.html">graphql/resolvers/index</a></li><li><a href="module-graphql_resolvers_plantResolvers.html">graphql/resolvers/plantResolvers</a></li><li><a href="module-graphql_resolvers_settingsResolvers.html">graphql/resolvers/settingsResolvers</a></li><li><a href="module-graphql_resolvers_userResolvers.html">graphql/resolvers/userResolvers</a></li><li><a href="module-graphql_schemas_countrySchema.html">graphql/schemas/countrySchema</a></li><li><a href="module-graphql_schemas_distillationArchivesSchema.html">graphql/schemas/distillationArchivesSchema</a></li><li><a href="module-graphql_schemas_distillationSchema.html">graphql/schemas/distillationSchema</a></li><li><a href="module-graphql_schemas_index.html">graphql/schemas/index</a></li><li><a href="module-graphql_schemas_plantSchema.html">graphql/schemas/plantSchema</a></li><li><a href="module-graphql_schemas_settingsSchema.html">graphql/schemas/settingsSchema</a></li><li><a href="module-graphql_schemas_userSchema.html">graphql/schemas/userSchema</a></li><li><a href="module-util_dateformater.html">util/dateformater</a></li></ul><h3>Global</h3><ul><li><a href="global.html#filterData">filterData</a></li><li><a href="global.html#requireAuth">requireAuth</a></li><li><a href="global.html#sanitizeDistillationInput">sanitizeDistillationInput</a></li><li><a href="global.html#sanitizeDistillerInput">sanitizeDistillerInput</a></li><li><a href="global.html#sanitizePlantInput">sanitizePlantInput</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.5</a> on Sat Nov 08 2025 13:57:28 GMT+0100 (Central European Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
